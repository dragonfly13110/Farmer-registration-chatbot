# app.py (р╕Йр╕Ър╕▒р╕Ър╕кр╕бр╕Ър╕╣р╕гр╕Ур╣М Final - р╣Гр╕Кр╣Й Smart Prompting р╕Бр╕▒р╕Ъ Gemini)

import streamlit as st
import os
import random
from dotenv import load_dotenv

# --- р╕кр╣Ир╕зр╕Щр╕Чр╕╡р╣Ир╕Хр╣Йр╕нр╕Зр╣Гр╕Кр╣Йр╕Ир╕▓р╕Б LangChain р╣Бр╕ер╕░ Google (р╕Ыр╕гр╕▒р╕Ър╕Ыр╕гр╕╕р╕Зр╣Гр╕лр╕бр╣И) ---
from langchain_community.vectorstores import FAISS
from langchain_huggingface import HuggingFaceEmbeddings

# LangChain components for conversational memory and RAG
from langchain_google_genai import ChatGoogleGenerativeAI
from langchain_core.messages import HumanMessage, AIMessage # For converting Streamlit history to LangChain messages
from langchain_core.chat_history import InMemoryChatMessageHistory
from langchain_core.runnables.history import RunnableWithMessageHistory
from langchain_core.prompts import ChatPromptTemplate, MessagesPlaceholder
from langchain_core.output_parsers import StrOutputParser # To parse the output from the LLM

# --- р╣Вр╕лр╕ер╕Фр╕Др╣Ир╕▓р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓р╣Бр╕ер╕░р╣Вр╕бр╣Ар╕Фр╕е ---
load_dotenv()

# р╕Хр╕▒р╣Йр╕Зр╕Др╣Ир╕▓ Google API Key (р╣Гр╕Кр╣Йр╕гр╕░р╕Ър╕Ъ Key Rotation р╕Чр╕╡р╣Ир╣Ар╕гр╕▓р╕Чр╕│р╣Др╕зр╣Й)
api_keys = [
    os.getenv("GOOGLE_API_KEY_1"),
    os.getenv("GOOGLE_API_KEY_2"),
    os.getenv("GOOGLE_API_KEY_3"),
]
api_key_pool = [key for key in api_keys if key]

if not api_key_pool:
    st.error("р╣Др╕бр╣Ир╕Юр╕Ъ Google API Key р╣Гр╕Фр╣Ж р╣Гр╕Щр╣Др╕Яр╕ер╣М .env! р╕Бр╕гр╕╕р╕Ур╕▓р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ")

VECTORSTORE_PATH = "vectorstore_combined"
EMBEDDING_MODEL = "intfloat/multilingual-e5-large"

# --- р╕Яр╕▒р╕Зр╕Бр╣Мр╕Кр╕▒р╕Щр╕лр╕ер╕▒р╕Б ---

@st.cache_resource
def load_vector_store():
    """р╣Вр╕лр╕ер╕Ф Vector Store р╕Чр╕╡р╣Ир╕кр╕гр╣Йр╕▓р╕Зр╣Др╕зр╣Йр╣Бр╕ер╣Йр╕з (р╕Чр╕│р╕Др╕гр╕▒р╣Йр╕Зр╣Ар╕Фр╕╡р╕вр╕з)"""
    if not os.path.exists(VECTORSTORE_PATH):
        st.error(f"р╣Др╕бр╣Ир╕Юр╕Ър╕Рр╕▓р╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕е Vector Store р╕Чр╕╡р╣И '{VECTORSTORE_PATH}'! р╕Бр╕гр╕╕р╕Ур╕▓р╕гр╕▒р╕Щр╣Др╕Яр╕ер╣М `1_prepare_vectorstore.py` р╕Бр╣Ир╕нр╕Щ")
        return None
    try:
        embeddings = HuggingFaceEmbeddings(model_name=EMBEDDING_MODEL)
        db = FAISS.load_local(
            VECTORSTORE_PATH, 
            embeddings, 
            allow_dangerous_deserialization=True
        )
        return db
    except Exception as e:
        st.error(f"р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╣Вр╕лр╕ер╕Ф Vector Store: {e}")
        return None

# Store chat history outside the chain for Streamlit's session state
# This is a simple in-memory store for a single user session.
# For multi-user applications, this would need to be more sophisticated (e.g., database).
store = {}
def get_session_history(session_id: str) -> InMemoryChatMessageHistory:
    if session_id not in store:
        store[session_id] = InMemoryChatMessageHistory()
    return store[session_id]

def create_chains():
    """
    р╕кр╕гр╣Йр╕▓р╕З LangChain runnables р╕кр╕нр╕Зр╕Кр╕╕р╕Ф:
    1. rewriter_chain: р╕кр╕│р╕лр╕гр╕▒р╕Ър╣Бр╕Ыр╕ер╕Зр╕Др╕│р╕Цр╕▓р╕бр╕Вр╕нр╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╣Гр╕лр╣Йр╣Ар╕Ыр╣Зр╕Щ search query р╕Чр╕╡р╣Ир╕Фр╕╡р╕Вр╕╢р╣Йр╕Щ
    2. answer_chain: р╕кр╕│р╕лр╕гр╕▒р╕Ър╕кр╕гр╣Йр╕▓р╕Зр╕Др╕│р╕Хр╕нр╕Ър╕кр╕╕р╕Фр╕Чр╣Йр╕▓р╕вр╕Ир╕▓р╕Б context р╣Бр╕ер╕░р╕Др╕│р╕Цр╕▓р╕б
    """
    if not api_key_pool:
        st.error("р╣Др╕бр╣Ир╕Юр╕Ъ Google API Key р╣Гр╕Фр╣Ж р╣Гр╕Щр╣Др╕Яр╕ер╣М .env! р╣Др╕бр╣Ир╕кр╕▓р╕бр╕▓р╕гр╕Цр╕кр╕гр╣Йр╕▓р╕Зр╣Вр╕бр╣Ар╕Фр╕ер╣Др╕Фр╣Й")
        return None, None

    # р╕кр╕гр╣Йр╕▓р╕З LLM instance р╣Ар╕Фр╕╡р╕вр╕зр╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕Кр╣Йр╕гр╣Ир╕зр╕бр╕Бр╕▒р╕Щ
    selected_key = random.choice(api_key_pool)
    llm = ChatGoogleGenerativeAI(
        model="gemini-1.5-flash-latest",
        temperature=0.7,
        google_api_key=selected_key,
    )

    # 1. Chain р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╣Бр╕Ыр╕ер╕Зр╕Др╕│р╕Цр╕▓р╕б (Query Transformation)
    rewrite_prompt = ChatPromptTemplate.from_messages(
        [
            ("system", """р╕Др╕╕р╕Ур╕Др╕╖р╕нр╕Ьр╕╣р╣Йр╕Кр╣Ир╕зр╕в AI р╕Чр╕╡р╣Ир╣Ар╕Кр╕╡р╣Ир╕вр╕зр╕Кр╕▓р╕Нр╣Гр╕Щр╕Бр╕▓р╕гр╣Бр╕Ыр╕ер╕Зр╕Др╕│р╕Цр╕▓р╕бр╕Вр╕нр╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╣Гр╕лр╣Йр╣Ар╕Ыр╣Зр╕Щр╕Др╕│р╕Др╣Йр╕Щр╕лр╕▓ (Search Query) р╕Чр╕╡р╣Ир╕бр╕╡р╕Ыр╕гр╕░р╕кр╕┤р╕Чр╕Шр╕┤р╕ар╕▓р╕Юр╕кр╕│р╕лр╕гр╕▒р╕Ъ Vector Database
р╕ар╕▓р╕гр╕Бр╕┤р╕Ир╕Вр╕нр╕Зр╕Др╕╕р╕Ур╕Др╕╖р╕нр╕Бр╕▓р╕гр╕нр╣Ир╕▓р╕Щр╕Ър╕Чр╕кр╕Щр╕Чр╕Щр╕▓р╕ер╣Ир╕▓р╕кр╕╕р╕Фр╣Бр╕ер╕░р╕Др╕│р╕Цр╕▓р╕бр╕Хр╕┤р╕Фр╕Хр╕▓р╕бр╕Ьр╕е р╣Бр╕ер╣Йр╕зр╕кр╕гр╣Йр╕▓р╕Зр╕Др╕│р╕Др╣Йр╕Щр╕лр╕▓р╕Чр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щр╕Ыр╕гр╕░р╣Вр╕вр╕Др╕кр╕бр╕Ър╕╣р╕гр╕Ур╣М (Standalone Question) р╕Чр╕╡р╣Ир╣Ар╕лр╕бр╕▓р╕░р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Др╣Йр╕Щр╕лр╕▓р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Щр╕Др╕╣р╣Ир╕бр╕╖р╕нр╕Бр╕▓р╕гр╕Вр╕╢р╣Йр╕Щр╕Чр╕░р╣Ар╕Ър╕╡р╕вр╕Щр╣Ар╕Бр╕йр╕Хр╕гр╕Бр╕г

- р╕Др╕│р╕Др╣Йр╕Щр╕лр╕▓р╕Др╕зр╕гр╕Ир╕░р╕Кр╕▒р╕Фр╣Ар╕Ир╕Щр╣Бр╕ер╕░р╕Хр╕гр╕Зр╕Ыр╕гр╕░р╣Ар╕Фр╣Зр╕Щ
- р╣Бр╕Ыр╕ер╕Зр╕ар╕▓р╕йр╕▓р╕Юр╕╣р╕Фр╣Гр╕лр╣Йр╣Ар╕Ыр╣Зр╕Щр╕ар╕▓р╕йр╕▓р╕Чр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щр╕Чр╕▓р╕Зр╕Бр╕▓р╕гр╕бр╕▓р╕Бр╕Вр╕╢р╣Йр╕Щ (р╣Ар╕Кр╣Ир╕Щ "р╕Чр╕│р╕кр╕зр╕Щ" -> "р╕Бр╕▓р╕гр╣Ар╕Юр╕▓р╕░р╕Ыр╕ер╕╣р╕Бр╕Юр╕╖р╕К", "р╕Хр╣Йр╕нр╕Зр╣Гр╕Кр╣Йр╕нр╕░р╣Др╕гр╕Ър╣Йр╕▓р╕З" -> "р╣Ар╕нр╕Бр╕кр╕▓р╕гр╣Бр╕ер╕░р╕Др╕╕р╕Ур╕кр╕бр╕Ър╕▒р╕Хр╕┤р╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щ")
- р╕гр╕зр╕бр╕Ър╕гр╕┤р╕Ър╕Чр╕Чр╕╡р╣Ир╕кр╕│р╕Др╕▒р╕Нр╕Ир╕▓р╕Бр╕Ър╕Чр╕кр╕Щр╕Чр╕Щр╕▓р╕Бр╣Ир╕нр╕Щр╕лр╕Щр╣Йр╕▓р╣Ар╕Вр╣Йр╕▓р╕бр╕▓р╣Гр╕Щр╕Др╕│р╕Др╣Йр╕Щр╕лр╕▓р╣Гр╕лр╕бр╣И

р╕Хр╕▒р╕зр╕нр╕вр╣Ир╕▓р╕З:
р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕кр╕Щр╕Чр╕Щр╕▓:
Human: р╕Ьр╕бр╕Ыр╕ер╕╣р╕Бр╕Чр╕╕р╣Ар╕гр╕╡р╕вр╕Щ 10 р╣Др╕гр╣Ир╕Др╕гр╕▒р╕Ъ
AI: р╕гр╕▒р╕Ър╕Чр╕гр╕▓р╕Ър╕Др╕гр╕▒р╕Ъ р╕Бр╕▓р╕гр╕Ыр╕ер╕╣р╕Бр╕Чр╕╕р╣Ар╕гр╕╡р╕вр╕Щр╕Ир╕▒р╕Фр╣Ар╕Ыр╣Зр╕Щр╣Др╕бр╣Йр╕Ьр╕е р╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕нр╕░р╣Др╕гр╣Гр╕лр╣Йр╕Кр╣Ир╕зр╕вр╣Др╕лр╕бр╕Др╕гр╕▒р╕Ъ
р╕Др╕│р╕Цр╕▓р╕бр╕Хр╕┤р╕Фр╕Хр╕▓р╕бр╕Ьр╕е:
р╣Бр╕ер╣Йр╕зр╕Хр╣Йр╕нр╕Зр╣Гр╕Кр╣Йр╣Ар╕нр╕Бр╕кр╕▓р╕гр╕нр╕░р╣Др╕гр╕Ър╣Йр╕▓р╕Зр╕Др╕гр╕▒р╕Ъ

р╕Др╕│р╕Др╣Йр╕Щр╕лр╕▓р╕Чр╕╡р╣Ир╕Др╕зр╕гр╕кр╕гр╣Йр╕▓р╕З:
"р╣Ар╕нр╕Бр╕кр╕▓р╕гр╕Чр╕╡р╣Ир╕Ир╕│р╣Ар╕Ыр╣Зр╕Щр╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕Вр╕╢р╣Йр╕Щр╕Чр╕░р╣Ар╕Ър╕╡р╕вр╕Щр╣Ар╕Бр╕йр╕Хр╕гр╕Бр╕гр╕Ьр╕╣р╣Йр╕Ыр╕ер╕╣р╕Бр╕Чр╕╕р╣Ар╕гр╕╡р╕вр╕Щр╕бр╕╡р╕нр╕░р╣Др╕гр╕Ър╣Йр╕▓р╕З"
"""),
            MessagesPlaceholder(variable_name="chat_history"),
            ("human", "{question}"),
        ]
    )
    
    rewriter_chain_base = rewrite_prompt | llm | StrOutputParser()
    rewriter_chain = RunnableWithMessageHistory(
        rewriter_chain_base,
        get_session_history,
        input_messages_key="question",
        history_messages_key="chat_history",
    )

    # 2. Chain р╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕▓р╕гр╕кр╕гр╣Йр╕▓р╕Зр╕Др╕│р╕Хр╕нр╕Ър╕кр╕╕р╕Фр╕Чр╣Йр╕▓р╕в (RAG)
    # Prompt р╕Щр╕╡р╣Йр╕Ир╕░р╕гр╕▒р╕Ъ context р╕Чр╕╡р╣Ир╕Др╣Йр╕Щр╕лр╕▓р╕бр╕▓р╣Бр╕ер╣Йр╕з, р╕Др╕│р╕Цр╕▓р╕бр╕Фр╕▒р╣Йр╕Зр╣Ар╕Фр╕┤р╕б, р╣Бр╕ер╕░р╕Ыр╕гр╕░р╕зр╕▒р╕Хр╕┤р╕Бр╕▓р╕гр╕кр╕Щр╕Чр╕Щр╕▓
    answer_prompt = ChatPromptTemplate.from_messages(
        [
            ("system", """р╕Др╕╕р╕Ур╕Др╕╖р╕н "р╕Ьр╕╣р╣Йр╣Ар╕Кр╕╡р╣Ир╕вр╕зр╕Кр╕▓р╕Нр╣Гр╕лр╣Йр╕Др╕│р╕Ыр╕гр╕╢р╕Бр╕йр╕▓р╕Фр╣Йр╕▓р╕Щр╕Бр╕▓р╕гр╕Вр╕╢р╣Йр╕Щр╕Чр╕░р╣Ар╕Ър╕╡р╕вр╕Щр╣Ар╕Бр╕йр╕Хр╕гр╕Бр╕г" р╕Чр╕╡р╣Ир╕бр╕╡р╕Др╕зр╕▓р╕бр╕гр╕╣р╣Йр╕Ир╕▓р╕Бр╕Др╕╣р╣Ир╕бр╕╖р╕нр╕нр╕вр╣Ир╕▓р╕Зр╕ер╕░р╣Ар╕нр╕╡р╕вр╕Ф р╣Бр╕ер╕░р╕бр╕╡р╕Др╕зр╕▓р╕бр╕кр╕▓р╕бр╕▓р╕гр╕Цр╣Гр╕Щр╕Бр╕▓р╕гр╣Гр╕лр╣Йр╣Ар╕лр╕Хр╕╕р╕Ьр╕ер╣Ар╕Юр╕╖р╣Ир╕нр╕Кр╣Ир╕зр╕вр╣Ар╕лр╕ер╕╖р╕нр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й

**р╕ар╕▓р╕гр╕Бр╕┤р╕Ир╕Вр╕нр╕Зр╕Др╕╕р╕У:** р╕Хр╕нр╕Ър╕Др╕│р╕Цр╕▓р╕бр╕Вр╕нр╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Йр╣Гр╕лр╣Йр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕З, р╣Ар╕Ыр╣Зр╕Щр╕Ыр╕гр╕░р╣Вр╕вр╕Кр╕Щр╣М, р╕Бр╕гр╕░р╕Кр╕▒р╕Ъ, р╣Бр╕ер╕░р╕нр╣Ир╕▓р╕Щр╕Зр╣Ир╕▓р╕вр╕Чр╕╡р╣Ир╕кр╕╕р╕Ф р╣Вр╕Фр╕вр╕бр╕╡р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Бр╕▓р╕гр╕Др╕┤р╕Фр╣Бр╕ер╕░р╕Хр╕нр╕Ър╕Фр╕▒р╕Зр╕Щр╕╡р╣Й:

**р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣И 1: р╕Хр╕╡р╕Др╕зр╕▓р╕бр╕Др╕│р╕Цр╕▓р╕б (Intent Recognition)**
- р╕нр╣Ир╕▓р╕Щ "р╕Др╕│р╕Цр╕▓р╕бр╕Вр╕нр╕Зр╕Ьр╕╣р╣Йр╣Гр╕Кр╣Й" р╣Бр╕ер╕░р╕Чр╕│р╕Др╕зр╕▓р╕бр╣Ар╕Вр╣Йр╕▓р╣Гр╕Ир╣Ар╕Ир╕Хр╕Щр╕▓р╕Чр╕╡р╣Ир╣Бр╕Чр╣Йр╕Ир╕гр╕┤р╕З
- р╕Хр╕╡р╕Др╕зр╕▓р╕бр╕Др╕│р╕ир╕▒р╕Юр╕Чр╣Мр╕ар╕▓р╕йр╕▓р╕Юр╕╣р╕Фр╣Гр╕лр╣Йр╣Ар╕Ыр╣Зр╕Щр╕Др╕│р╕Чр╕╡р╣Ир╣Ар╕Ыр╣Зр╕Щр╕Чр╕▓р╕Зр╕Бр╕▓р╕г (р╣Ар╕Кр╣Ир╕Щ "р╕кр╕зр╕Щр╣Ар╕Зр╕▓р╕░" р╕лр╕бр╕▓р╕вр╕Цр╕╢р╕З "р╣Др╕бр╣Йр╕Ьр╕е")

**р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣И 2: р╕Др╣Йр╕Щр╕лр╕▓р╣Бр╕ер╕░р╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Бр╕▒р╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕З (Fact-Checking)**
- р╕Щр╕│р╕Др╕зр╕▓р╕бр╣Ар╕Вр╣Йр╕▓р╣Гр╕Ир╕Ир╕▓р╕Бр╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣И 1 р╣Др╕Ыр╕Др╣Йр╕Щр╕лр╕▓р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Вр╣Йр╕нр╕Зр╕Чр╕╡р╣Ир╕кр╕╕р╕Фр╣Гр╕Щ "р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕З" р╕Чр╕╡р╣Ир╣Гр╕лр╣Йр╕бр╕▓
- р╕вр╕╢р╕Фр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Щ "р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕З" р╣Ар╕Ыр╣Зр╕Щр╕Др╕зр╕▓р╕бр╕Ир╕гр╕┤р╕Зр╕кр╕╣р╕Зр╕кр╕╕р╕Фр╣Ар╕кр╕бр╕н

**р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣И 3: р╕кр╕гр╣Йр╕▓р╕Зр╕Др╕│р╕Хр╕нр╕Ър╕Юр╕гр╣Йр╕нр╕бр╕Ир╕▒р╕Фр╕гр╕╣р╕Ыр╣Бр╕Ър╕Ъ (Formatted Response Generation)**
- р╕кр╕гр╣Йр╕▓р╕Зр╕Др╕│р╕Хр╕нр╕Ър╕Хр╕▓р╕бр╕Бр╕гр╕Ур╕╡р╕Фр╣Йр╕▓р╕Щр╕ер╣Ир╕▓р╕Зр╕Щр╕╡р╣Й р╣Бр╕ер╕░ **р╕Хр╣Йр╕нр╕Зр╕Ир╕▒р╕Фр╕гр╕╣р╕Ыр╣Бр╕Ър╕Ър╕Др╕│р╕Хр╕нр╕Ър╣Гр╕лр╣Йр╕нр╣Ир╕▓р╕Щр╕Зр╣Ир╕▓р╕вр╣Ар╕кр╕бр╕н**
- **р╕Бр╕Ор╕Бр╕▓р╕гр╕Ир╕▒р╕Фр╕гр╕╣р╕Ыр╣Бр╕Ър╕Ъ:**
  - **р╕Бр╕гр╕░р╕Кр╕▒р╕Ъ:** р╣Гр╕Кр╣Йр╕Ыр╕гр╕░р╣Вр╕вр╕Др╕кр╕▒р╣Йр╕Щр╣Ж р╕Хр╕гр╕Зр╕Ыр╕гр╕░р╣Ар╕Фр╣Зр╕Щ
  - **р╕вр╣Ир╕нр╕лр╕Щр╣Йр╕▓:** р╕лр╕▓р╕Бр╕Др╕│р╕Хр╕нр╕Ър╕бр╕╡р╕лр╕ер╕▓р╕вр╕Ыр╕гр╕░р╣Ар╕Фр╣Зр╕Щ р╣Гр╕лр╣Йр╣Бр╕Ър╣Ир╕Зр╣Ар╕Ыр╣Зр╕Щр╕вр╣Ир╕нр╕лр╕Щр╣Йр╕▓р╕кр╕▒р╣Йр╕Щр╣Ж
  - **р╕лр╕▒р╕зр╕Вр╣Йр╕н/Bullet Points:** р╕лр╕▓р╕Бр╣Ар╕Ыр╣Зр╕Щр╕Бр╕▓р╕гр╣Гр╕лр╣Йр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕лр╕ер╕▓р╕вр╕Вр╣Йр╕н р╣Гр╕лр╣Йр╣Гр╕Кр╣Йр╕лр╕▒р╕зр╕Вр╣Йр╕нр╕кр╕▒р╣Йр╕Щр╣Ж р╕лр╕гр╕╖р╕н bullet points (р╣Ар╕Др╕гр╕╖р╣Ир╕нр╕Зр╕лр╕бр╕▓р╕в -) р╣Ар╕Юр╕╖р╣Ир╕нр╣Бр╕вр╕Бр╕Ыр╕гр╕░р╣Ар╕Фр╣Зр╕Щ
  - **р╕нр╕╡р╣Вр╕бр╕Ир╕┤:** р╣Гр╕Кр╣Йр╕нр╕╡р╣Вр╕бр╕Ир╕┤р╕Чр╕╡р╣Ир╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Вр╣Йр╕нр╕З 1-2 р╕Хр╕▒р╕зр╕Хр╣Ир╕нр╕лр╕Щр╕╢р╣Ир╕Зр╕Др╕│р╕Хр╕нр╕Ъ р╣Ар╕Юр╕╖р╣Ир╕нр╣Гр╕лр╣Йр╕Фр╕╣р╣Ар╕Ыр╣Зр╕Щр╕бр╕┤р╕Хр╕г (р╣Ар╕Кр╣Ир╕Щ тЬЕ, тЭМ, ЁЯУЛ, ЁЯМ╛, ЁЯТб) р╣Бр╕Хр╣Ир╕нр╕вр╣Ир╕▓р╣Гр╕Кр╣Йр╣Ар╕вр╕нр╕░р╣Ар╕Бр╕┤р╕Щр╣Др╕Ы

 - **р╣Бр╕Щр╕зр╕Чр╕▓р╕Зр╕Бр╕▓р╕гр╕Хр╕нр╕Ъ:**
  - **р╕Бр╕гр╕Ур╕╡р╕Чр╕╡р╣И 1 (р╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Хр╕гр╕Зр╣Ж):** р╕кр╕гр╕╕р╕Ыр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╕Юр╕Ър╕бр╕▓р╕Хр╕нр╕Ър╣Вр╕Фр╕вр╕Хр╕гр╕З р╕Юр╕гр╣Йр╕нр╕бр╕Ир╕▒р╕Фр╕гр╕╣р╕Ыр╣Бр╕Ър╕Ър╣Гр╕лр╣Йр╕нр╣Ир╕▓р╕Щр╕Зр╣Ир╕▓р╕в
  - **р╕Бр╕гр╕Ур╕╡р╕Чр╕╡р╣И 2 (р╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Бр╕ер╣Йр╣Ар╕Др╕╡р╕вр╕З):** р╕Щр╕│р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╕Юр╕Ър╕бр╕▓р╕Хр╕нр╕Ъ р╣Бр╕ер╣Йр╕зр╕нр╕▓р╕Ир╕Ир╕░р╣Ар╕кр╕гр╕┤р╕бр╕зр╣Ир╕▓ "р╕Лр╕╢р╣Ир╕Зр╣Ар╕Бр╕Ур╕Ср╣Мр╕Щр╕╡р╣Йр╣Гр╕Кр╣Йр╕Бр╕▒р╕Ър╣Др╕бр╣Йр╕Ьр╕ер╣Вр╕Фр╕вр╕Чр╕▒р╣Ир╕зр╣Др╕Ы р╕гр╕зр╕бр╕Цр╕╢р╕Зр╣Ар╕Зр╕▓р╕░р╕Фр╣Йр╕зр╕вр╕Др╕гр╕▒р╕Ъ"
  - **р╕Бр╕гр╕Ур╕╡р╕Чр╕╡р╣И 3 (р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Вр╕Фр╕вр╕Хр╕гр╕З р╣Бр╕Хр╣Ир╕бр╕╡р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Вр╣Йр╕нр╕З):** р╣Ар╕гр╕┤р╣Ир╕бр╕Хр╣Йр╕Щр╕зр╣Ир╕▓ "р╕Хр╣Йр╕нр╕Зр╕Вр╕нр╕нр╕ар╕▒р╕вр╕Др╕гр╕▒р╕Ъ ЁЯШе р╕Ир╕▓р╕Бр╕Бр╕▓р╕гр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ъ р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕кр╕│р╕лр╕гр╕▒р╕Ър╕Бр╕гр╕Ур╕╡р╕Вр╕нр╕Зр╕Др╕╕р╕Ур╣Вр╕Фр╕вр╣Ар╕Йр╕Юр╕▓р╕░ р╣Бр╕Хр╣Ир╕бр╕╡р╕лр╕ер╕▒р╕Бр╣Ар╕Бр╕Ур╕Ср╣Мр╕Чр╕▒р╣Ир╕зр╣Др╕Ыр╕Чр╕╡р╣Ир╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Вр╣Йр╕нр╕Зр╕Фр╕▒р╕Зр╕Щр╕╡р╣Йр╕Др╕гр╕▒р╕Ъ:" р╕Ир╕▓р╕Бр╕Щр╕▒р╣Йр╕Щр╣Гр╕лр╣Йр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Щр╕▒р╣Йр╕Щр╣Гр╕Щр╕гр╕╣р╕Ыр╣Бр╕Ър╕Ъ bullet points
  - **р╕Бр╕гр╕Ур╕╡р╕Чр╕╡р╣И 4 (р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Ар╕ер╕в):** р╕Хр╕нр╕Ър╕нр╕вр╣Ир╕▓р╕Зр╕кр╕╕р╕ар╕▓р╕Юр╕зр╣Ир╕▓: "р╕Хр╣Йр╕нр╕Зр╕Вр╕нр╕нр╕ар╕▒р╕вр╕Др╕гр╕▒р╕Ъ р╣Др╕бр╣Ир╕Юр╕Ър╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Вр╣Йр╕нр╕Зр╕Бр╕▒р╕Ър╣Ар╕гр╕╖р╣Ир╕нр╕Зр╕Щр╕╡р╣Йр╣Гр╕Щр╕Др╕╣р╣Ир╕бр╕╖р╕нр╣Ар╕ер╕в ЁЯУВ р╣Ар╕Юр╕╖р╣Ир╕нр╕Др╕зр╕▓р╕бр╕Цр╕╣р╕Бр╕Хр╣Йр╕нр╕Зр╕Чр╕╡р╣Ир╕кр╕╕р╕Ф р╕Ьр╕бр╣Бр╕Щр╕░р╕Щр╕│р╣Гр╕лр╣Йр╕ер╕нр╕Зр╕кр╕нр╕Ър╕Цр╕▓р╕бр╣Вр╕Фр╕вр╕Хр╕гр╕Зр╕Бр╕▒р╕Ър╣Ар╕Ир╣Йр╕▓р╕лр╕Щр╣Йр╕▓р╕Чр╕╡р╣И р╕У р╕кр╕│р╕Щр╕▒р╕Бр╕Зр╕▓р╕Щр╣Ар╕Бр╕йр╕Хр╕гр╕нр╕│р╣Ар╕ар╕нр╣Гр╕Бр╕ер╣Йр╕Ър╣Йр╕▓р╕Щр╕Чр╣Ир╕▓р╕Щр╕Щр╕░р╕Др╕гр╕▒р╕Ъ"
  - **р╕Бр╕гр╕Ур╕╡р╕Чр╕╡р╣И 5 (р╕Др╕│р╕Цр╕▓р╕бр╣Др╕бр╣Ир╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Вр╣Йр╕нр╕З):** р╕Хр╕нр╕Ър╕зр╣Ир╕▓ "р╕Хр╣Йр╕нр╕Зр╕Вр╕нр╕нр╕ар╕▒р╕вр╕Др╕гр╕▒р╕Ъ р╕Др╕│р╕Цр╕▓р╕бр╕Щр╕╡р╣Йр╣Др╕бр╣Ир╣Ар╕Бр╕╡р╣Ир╕вр╕зр╕Вр╣Йр╕нр╕Зр╕Бр╕▒р╕Ър╕Бр╕▓р╕гр╕Вр╕╢р╣Йр╕Щр╕Чр╕░р╣Ар╕Ър╕╡р╕вр╕Щр╣Ар╕Бр╕йр╕Хр╕гр╕Бр╕г"
**р╕Вр╣Йр╕нр╕Др╕зр╕гр╕Ир╕│:** р╕лр╣Йр╕▓р╕бр╕кр╕гр╣Йр╕▓р╕Зр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Чр╕╡р╣Ир╣Др╕бр╣Ир╕бр╕╡р╕нр╕вр╕╣р╣Ир╣Гр╕Щ "р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕З" р╕Вр╕╢р╣Йр╕Щр╕бр╕▓р╣Ар╕нр╕Зр╣Ар╕Фр╣Зр╕Фр╕Вр╕▓р╕Ф
**р╕кр╕│р╕Др╕▒р╕Нр╕бр╕▓р╕Б:** р╕лр╕▓р╕Бр╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Гр╕Щ "р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕З" р╣Др╕бр╣Ир╣Ар╕Юр╕╡р╕вр╕Зр╕Юр╕нр╕Хр╣Ир╕нр╕Бр╕▓р╕гр╕Хр╕нр╕Ър╕Др╕│р╕Цр╕▓р╕бр╣Вр╕Фр╕вр╕Хр╕гр╕З р╣Гр╕лр╣Йр╕Хр╕нр╕Ър╕Хр╕▓р╕б "р╣Бр╕Щр╕зр╕Чр╕▓р╕Зр╕Бр╕▓р╕гр╕Хр╕нр╕Ъ" р╕Бр╕гр╕Ур╕╡р╕Чр╕╡р╣И 3 р╕лр╕гр╕╖р╕н 4 р╕нр╕вр╣Ир╕▓р╕Зр╣Ар╕Др╕гр╣Ир╕Зр╕Др╕гр╕▒р╕Ф р╕лр╣Йр╕▓р╕бр╣Гр╕Кр╣Йр╕Др╕зр╕▓р╕бр╕гр╕╣р╣Йр╕Чр╕▒р╣Ир╕зр╣Др╕Ыр╕бр╕▓р╕Хр╕нр╕Ър╣Бр╕Чр╕Щр╕Вр╣Йр╕нр╕бр╕╣р╕ер╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕З

---
**р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕З:**
{context}
---
"""),
            MessagesPlaceholder(variable_name="chat_history"), # This is where previous messages go
            ("human", "{question}")
        ]
    )

    answer_chain_base = answer_prompt | llm | StrOutputParser()
    answer_chain = RunnableWithMessageHistory(
        answer_chain_base,
        get_session_history,
        input_messages_key="question", # This will also receive 'context'
        history_messages_key="chat_history",
    )

    return rewriter_chain, answer_chain

# --- р╕кр╣Ир╕зр╕Щр╕Вр╕нр╕Зр╕лр╕Щр╣Йр╕▓р╣Ар╕зр╣Зр╕Ъ (Streamlit UI) ---
st.set_page_config(page_title="р╣Ар╕Бр╕йр╕Хр╕гр╕Бр╕гр╣Бр╕Кр╕Хр╕Ър╕нр╕Ч", page_icon="ЁЯСйтАНЁЯМ╛")
st.title("ЁЯСйтАНЁЯМ╛ р╣Бр╕Кр╕Хр╕Ър╕нр╕Чр╕Цр╕▓р╕б-р╕Хр╕нр╕Ър╣Ар╕гр╕╖р╣Ир╕нр╕Зр╕Бр╕▓р╕гр╕Вр╕╢р╣Йр╕Щр╕Чр╕░р╣Ар╕Ър╕╡р╕вр╕Щр╣Ар╕Бр╕йр╕Хр╕гр╕Бр╕г")
st.write("р╕Вр╕▒р╕Ър╣Ар╕Др╕ер╕╖р╣Ир╕нр╕Щр╣Вр╕Фр╕в Google Gemini р╣Бр╕ер╕░р╕Чр╕░р╣Ар╕Ър╕╡р╕вр╕Щр╣Ар╕Бр╕йр╕Хр╕гр╕Бр╕г р╕Ыр╕╡ 2568 р╕Бр╕гр╕бр╕кр╣Ир╕Зр╣Ар╕кр╕гр╕┤р╕бр╕Бр╕▓р╕гр╣Ар╕Бр╕йр╕Хр╕г")

db = load_vector_store()

if "messages" not in st.session_state:
    st.session_state.messages = []

for message in st.session_state.messages:
    with st.chat_message(message["role"]):
        st.markdown(message["content"])

# --- Main Logic ---
if db:
    # р╕кр╕гр╣Йр╕▓р╕З chains р╕Чр╕▒р╣Йр╕Зр╕кр╕нр╕Зр╣Бр╕ер╕░р╣Ар╕Бр╣Зр╕Ър╣Др╕зр╣Йр╣Гр╕Щ session state р╣Ар╕Юр╕╖р╣Ир╕нр╣Др╕бр╣Ир╣Гр╕лр╣Йр╕кр╕гр╣Йр╕▓р╕Зр╣Гр╕лр╕бр╣Ир╕Чр╕╕р╕Бр╕Др╕гр╕▒р╣Йр╕З
    if 'rewriter_chain' not in st.session_state or 'answer_chain' not in st.session_state:
        st.session_state.rewriter_chain, st.session_state.answer_chain = create_chains()

    if user_question := st.chat_input("р╕Юр╕┤р╕бр╕Юр╣Мр╕Др╕│р╕Цр╕▓р╕бр╕Вр╕нр╕Зр╕Др╕╕р╕Ур╕Чр╕╡р╣Ир╕Щр╕╡р╣И..."):
        st.session_state.messages.append({"role": "user", "content": user_question})
        with st.chat_message("user"):
            st.markdown(user_question)

        # р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣И 1: р╣Гр╕Кр╣Й Gemini р╕Кр╣Ир╕зр╕вр╣Бр╕Ыр╕ер╕Зр╕Др╕│р╕Цр╕▓р╕бр╣Гр╕лр╣Йр╕Фр╕╡р╕Вр╕╢р╣Йр╕Щ (Query Transformation)
        with st.spinner("р╕Бр╕│р╕ер╕▒р╕Зр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╣Бр╕ер╕░р╣Ар╕гр╕╡р╕вр╕Ър╣Ар╕гр╕╡р╕вр╕Зр╕Др╕│р╕Цр╕▓р╕бр╕Вр╕нр╕Зр╕Др╕╕р╕У..."):
            try:
                rewritten_question = st.session_state.rewriter_chain.invoke(
                    {"question": user_question},
                    config={"configurable": {"session_id": "streamlit_chat_session"}}
                )
            except Exception as e:
                st.error(f"р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╕зр╕┤р╣Ар╕Др╕гр╕▓р╕░р╕лр╣Мр╕Др╕│р╕Цр╕▓р╕б: {e}")
                st.stop()

        # р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣И 2: р╕Др╣Йр╕Щр╕лр╕▓р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕Фр╣Йр╕зр╕вр╕Др╕│р╕Цр╕▓р╕бр╕Чр╕╡р╣Ир╣Бр╕Ыр╕ер╕Зр╣Бр╕ер╣Йр╕з р╣Бр╕ер╕░р╕кр╕гр╣Йр╕▓р╕Зр╕Др╕│р╕Хр╕нр╕Ъ
        with st.spinner("р╕Бр╕│р╕ер╕▒р╕Зр╕Др╣Йр╕Щр╕лр╕▓р╕Вр╣Йр╕нр╕бр╕╣р╕ер╣Бр╕ер╕░р╕кр╕гр╣Йр╕▓р╕Зр╕Др╕│р╕Хр╕нр╕Ъ..."):
            # "р╕лр╕зр╣Ир╕▓р╕Щр╣Бр╕л" р╣Вр╕Фр╕вр╕Фр╕╢р╕Зр╣Ар╕нр╕Бр╕кр╕▓р╕гр╕бр╕▓ 10 р╕Кр╕┤р╣Йр╕Щ
            retrieved_docs = db.similarity_search(rewritten_question, k=10)

            context = "\n\n---\n\n".join([doc.page_content for doc in retrieved_docs])

            # р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Чр╕╡р╣И 3: р╣Ар╕гр╕╡р╕вр╕Б Chain р╕кр╕гр╣Йр╕▓р╕Зр╕Др╕│р╕Хр╕нр╕Ър╕кр╕╕р╕Фр╕Чр╣Йр╕▓р╕в
            try:
                final_answer = st.session_state.answer_chain.invoke(
                    {"question": user_question, "context": context}, # р╕кр╣Ир╕Зр╕Др╕│р╕Цр╕▓р╕бр╕Фр╕▒р╣Йр╕Зр╣Ар╕Фр╕┤р╕бр╣Бр╕ер╕░ context
                    config={"configurable": {"session_id": "streamlit_chat_session"}}, # Use a fixed session ID for this single-user app
                )
            except Exception as e:
                final_answer = f"р╕Вр╕нр╕нр╕ар╕▒р╕вр╕Др╕гр╕▒р╕Ъ р╣Ар╕Бр╕┤р╕Фр╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щр╕Бр╕▓р╕гр╣Ар╕Кр╕╖р╣Ир╕нр╕бр╕Хр╣Ир╕нр╕Бр╕▒р╕Ъ Gemini API р╕лр╕гр╕╖р╕нр╕Бр╕▓р╕гр╕Ыр╕гр╕░р╕бр╕зр╕ер╕Ьр╕е: {e}"
                st.error(final_answer) # Display error in Streamlit

            st.session_state.messages.append({"role": "assistant", "content": final_answer})
            with st.chat_message("assistant"):
                st.markdown(final_answer)

            with st.expander("р╕Фр╕╣р╕Вр╕▒р╣Йр╕Щр╕Хр╕нр╕Щр╕Бр╕▓р╕гр╕Чр╕│р╕Зр╕▓р╕Щр╕Вр╕нр╕З AI"):
                st.info(f"**р╕Др╕│р╕Др╣Йр╕Щр╕лр╕▓р╕Чр╕╡р╣И AI р╕кр╕гр╣Йр╕▓р╕Зр╕Вр╕╢р╣Йр╕Щр╣Ар╕Юр╕╖р╣Ир╕нр╕Др╣Йр╕Щр╕лр╕▓р╕Вр╣Йр╕нр╕бр╕╣р╕е:**\n\n> {rewritten_question}")
                st.success(f"**р╕Вр╣Йр╕нр╕бр╕╣р╕ер╕нр╣Йр╕▓р╕Зр╕нр╕┤р╕Зр╕Чр╕╡р╣Ир╕Юр╕Ър╣Бр╕ер╕░р╕кр╣Ир╕Зр╣Гр╕лр╣Й AI р╕Юр╕┤р╕Ир╕▓р╕гр╕Ур╕▓:**\n\n---\n{context}")
else:
    st.warning("р╕гр╕░р╕Ър╕Ър╕вр╕▒р╕Зр╣Др╕бр╣Ир╕Юр╕гр╣Йр╕нр╕бр╣Гр╕Кр╣Йр╕Зр╕▓р╕Щ р╕Бр╕гр╕╕р╕Ур╕▓р╕гр╕нр╣Гр╕лр╣Й Vector Store р╣Вр╕лр╕ер╕Фр╣Ар╕кр╕гр╣Зр╕Ир╕кр╕┤р╣Йр╕Щ р╕лр╕гр╕╖р╕нр╕Хр╕гр╕зр╕Ир╕кр╕нр╕Ър╕Вр╣Йр╕нр╕Ьр╕┤р╕Фр╕Юр╕ер╕▓р╕Фр╣Гр╕Щ Terminal")